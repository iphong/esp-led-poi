!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";n.r(t);n(2),n(9),n(3),n(4),n(5),n(6),n(7),n(8)},function(module,exports){document.head.innerHTML+="<style>\n\nx-console main {\n\tpadding: 0;\n\tmargin: 0;\n}\nx-console {\n\tz-index: 2000;\n\tdisplay: block;\n\tposition: fixed;\n\tbottom: 0;\n\tright: 0;\n\tleft: 0;\n\t\n\tbackground: #020202c9;\n\tborder: 10px solid #020202c9;\n\t\n\tbox-sizing: content-box;\n\tmax-height: 120px;\n\toverflow: auto;\n}\nx-console input,\nx-console output,\nx-console span {\n\tuser-select: text;\n\tfont-family: menlo;\n\tfont-size: 12px;\n\tline-height: 1.5em;\n}\nx-console input,\nx-console span {\n\theight: 1.5em;\n}\nx-console input,\nx-console output {\n\tdisplay: block;\n\tmargin: 0;\n\tpadding: 0;\n\tborder: none;\n\tbackground: none;\n\toutline: none;\n\twhite-space: pre !important;\n\tcolor: #fff;\n\ttext-align: left;\n}\nx-console line {\n\tdisplay: grid;\n\tgrid-template-columns: 20px auto;\n}\nx-console line span,\nx-console line output {\n\tcolor: lightgrey;\n}\nx-console line.debug * {\n\tcolor: lightgreen;\n}\nx-console line.info * {\n\tcolor: skyblue;\n}\nx-console line.warn * {\n\tcolor: yellow;\n}\nx-console line.error * {\n\tcolor: orangered;\n}\nx-console line.input * {\n\tcolor: white;\n}\nx-console line.input {\n\tdisplay: none;\n}\n</style>";class ConsoleElement{constructor(){this.el=document.createElement("x-console"),this.el.innerHTML='\n\t\t<main></main>\n\t\t<line class="input">\n\t\t\t<span>#</span>\n\t\t\t<input type="text" />\n\t\t</line>\n\t\t',this.main=this.el.querySelector("main"),this.input=this.el.querySelector("input"),this.input.addEventListener("keydown",this.handleKeydown.bind(this))}handleKeydown(e){if("Enter"===e.key){this.push("#","",e.target.value);try{this.push("•","info",String(eval(e.target.value)))}catch(e){this.push("•","error",e.stack)}e.target.value="",e.target.focus()}}push(e,t,...n){const o=document.createElement("line");t&&o.classList.add(t),o.innerHTML=`<span>${e}</span><output></output>`;const r=o.querySelector("output");r.innerText=n.join(" "),this.lastOutput=r,this.main.appendChild(o),this.el.scrollTop=this.el.scrollHeight}}const logger=new ConsoleElement;document.body.appendChild(logger.el);const original={};for(let e in console)original[e]=console[e];window.console.log=(...e)=>{original.log(...e),logger.push("•","log",...e)},window.console.debug=(...e)=>{original.debug(...e),logger.push("•","debug",...e)},window.console.info=(...e)=>{original.info(...e),logger.push("•","info",...e)},window.console.warn=(...e)=>{original.warn(...e),logger.push("•","warn",...e)},window.console.error=(...e)=>{original.error(...e),logger.push("•","error",...e)},window.console.append=(...e)=>{logger.lastOutput&&(logger.lastOutput.innerHTML=`${logger.lastOutput.innerHTML}${e.join(" ")}`)}},function(e,t,n){(function(e){e.rgbToHsl=function(e,t,n){e/=255,t/=255,n/=255;let o,r,a=Math.max(e,t,n),s=Math.min(e,t,n),l=(a+s)/2;if(a===s)o=r=0;else{let i=a-s;switch(r=l>.5?i/(2-a-s):i/(a+s),a){case e:o=(t-n)/i+(t<n?6:0);break;case t:o=(n-e)/i+2;break;case n:o=(e-t)/i+4}o/=6}return{h:o,s:r,l:l}},e.hslToRgb=function(t,n,o){let r,a,s;if(0===n)r=a=s=o;else{e.hue2rgb=function(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e};let l=o<.5?o*(1+n):o+n-o*n,i=2*o-l;r=hue2rgb(i,l,t+1/3),a=hue2rgb(i,l,t),s=hue2rgb(i,l,t-1/3)}return{r:255*r,g:255*a,b:255*s}},e.rgbToHsv=function(e,t,n){e/=255,t/=255,n/=255;let o,r,a=Math.max(e,t,n),s=Math.min(e,t,n),l=a,i=a-s;if(r=0===a?0:i/a,a===s)o=0;else{switch(a){case e:o=(t-n)/i+(t<n?6:0);break;case t:o=(n-e)/i+2;break;case n:o=(e-t)/i+4}o/=6}return{h:o,s:r,v:l}},e.hsvToRgb=function(e,t,n){let o,r,a,s=Math.floor(6*e),l=6*e-s,i=n*(1-t),c=n*(1-l*t),u=n*(1-(1-l)*t);switch(s%6){case 0:o=n,r=u,a=i;break;case 1:o=c,r=n,a=i;break;case 2:o=i,r=n,a=u;break;case 3:o=i,r=c,a=n;break;case 4:o=u,r=i,a=n;break;case 5:o=n,r=i,a=c}return{r:255*o,g:255*r,b:255*a}}}).call(this,n(0))},function(e,t,n){(function(e){e.CONFIG={mode:0,show:0,segment:"a",a:{r:255,g:0,b:0},b:{r:255,g:0,b:0}},e.AUDIO={id:0,url:"",filename:"",duration:0,channels:0,sampleRate:0,tempo:0,beats:0,tracks:[],color1:"#0000FF",color2:"#FF0000",ratio:.5,swap:!0},e.AUDIO_DEFAULT=Object.assign({},AUDIO),e.SHOWS=[],e.color={rgb:{r:255,g:0,b:0},hsl:{h:255,s:0,l:0}},e.updateRGB=function(){const{h:e,s:t,l:n}=color.hsl;color.rgb=hslToRgb(e,t,n)},e.updateHSL=function(){const{r:e,g:t,b:n}=color.rgb;color.hsl=rgbToHsl(e,t,n)},updateHSL(),window.updateRGB=updateRGB}).call(this,n(0))},function(e,t,n){(function(e){e.setText=function(e,t){void 0!==t&&document.querySelectorAll(e).forEach(e=>{e.innerText=t})},e.setValue=function(e,t){void 0!==t&&document.querySelectorAll(e).forEach(e=>{e.value=t})},e.setProp=function(e,t,n){void 0!==n&&document.querySelectorAll(e).forEach(e=>{e[t]=n})},e.setAttr=function(e,t,n){void 0!==n&&document.querySelectorAll(e).forEach(e=>{e.setAttribute(t,n)})},e.click=function(e){document.querySelectorAll(e).forEach(e=>{e.click()})},e.call=function(e,t,...n){document.querySelectorAll(e).forEach(e=>{"function"==typeof e[t]&&e[t].call(e,...n)})},e.renderColor=function(){Object.keys(color).forEach(e=>{Object.keys(color[e]).forEach(t=>{const n=document.querySelector(`input[data-group="${e}"][data-key="${t}"]`);if(n){n.value=color[e][t];const o=n.parentElement.querySelector("span");if(o)switch(e){case"hsl":o.innerText=Math.round(100*color[e][t])+"%";break;case"rgb":o.innerText=n.value}}})})},e.renderShow=function(){document.querySelectorAll("[data-segment]").forEach(e=>{e.dataset.segment===CONFIG.segment?e.classList.add("selected"):e.classList.remove("selected")}),document.querySelectorAll("[data-show]").forEach(e=>{parseInt(e.dataset.show)===CONFIG.show?e.classList.add("selected"):e.classList.remove("selected")}),document.querySelectorAll("section.tab").forEach(e=>{1!==parseInt(e.dataset.tab)||CONFIG.show?2===parseInt(e.dataset.tab)&&CONFIG.show?e.classList.add("active"):e.classList.remove("active"):e.classList.add("active")})},e.renderAudio=function(){setAttr("#player","src",AUDIO.url),setText("#audio-filename",AUDIO.filename),setText("#audio-duration",Math.round(AUDIO.duration)),setText("#audio-tempo",AUDIO.tempo),setText("#audio-beats",AUDIO.beats),setValue("#audio-color1",AUDIO.color1),setValue("#audio-color2",AUDIO.color2),setValue("#audio-ratio",AUDIO.ratio)},e.render=function(){renderShow(),renderColor(),renderAudio()}}).call(this,n(0))},function(e,t,n){(function(e){e.request=function(e="POST",t="",n={},o=null){return new Promise((r,a)=>{const s=new XMLHttpRequest,l=Object.entries(n),i=t+(l.length?"?"+l.map(([e,t])=>`${e}=${t}`).join("&"):"");console["DELETE"===e?"error":"POST"===e?"info":"log"](e+" "),console.append(i),console.append(o?` [${o.size||o.length} Kb]`:""),console.append(" ... "),s.open(e,i,!0),s.send(o),s.addEventListener("loadend",()=>{console.append(s.status,s.statusText),200===s.status?"application/json"===s.getResponseHeader("Content-Type")?r(JSON.parse(s.responseText)):r(s.responseText):a()}),s.addEventListener("error",a)})},e.uploadFile=function(e,t){return"string"==typeof t&&(t=new Blob([t])),console.warn(`UPLOAD ${e} [${(t.size/1e3).toFixed(2)} KB] ... `),new Promise((n,o)=>{const r=new FormData,a=new XMLHttpRequest;r.append("filename",e),r.append("file",t),a.open("POST","edit?sync",!0),a.send(r),a.onloadend=e=>{console.append(a.status,a.statusText),200===a.status?n(a):o(a)}})},e.get=function(e,t){return request("GET",e,t)},e.post=function(e,t,n){return request("POST",e,t,n)},e.sendCommand=function(e){return request("POST","/command",{command:e})},e.loadAudioConfig=function(){return get(`show/${CONFIG.show}.json`).then(e=>{Object.assign(AUDIO,e),renderAudio()})};let t=Date.now();e.fetchData=function(){t=Date.now();get("/status").then(e=>{Object.assign(CONFIG,e),renderShow(),get("/color").then(e=>{CONFIG.a={r:e.a[0],g:e.a[1],b:e.a[2]},CONFIG.b={r:e.b[0],g:e.b[1],b:e.b[2]},color.rgb=CONFIG[CONFIG.segment],updateHSL(),renderColor(),CONFIG.show&&loadAudioConfig()})})},e.stopShow=function(){return sendCommand("end").then(()=>{call("#player","pause"),setProp("#player","currentTime",0)})},e.startShow=function(){return sendCommand("start").then(()=>(setProp("#player","currentTime",0),call("#player","play")))},e.resetShow=function(){return console.log("reset show #"+CONFIG.show),AUDIO=Object.assign({},AUDIO_DEFAULT),AUDIO.id=CONFIG.show,SHOWS.length=0,render(),stopShow().then(saveAudioConfig).then(clearLightShow)},e.saveShow=function(){return stopShow().then(saveAudioConfig).then(saveLightShow).then(startShow)}}).call(this,n(0))},function(e,t,n){(function(e){const t=window.AudioContext||window.webkitAudioContext;e.getWaveformData=function(e){const t=e.getChannelData(0),n=e.sampleRate/10,o=10*e.duration,r=new Int8Array(2*o);for(let e=0;e<o;e++){let o=1,a=-1;const s=e*n;for(let e=0;e<n;e++)o=Math.min(o,t[s+e]),a=Math.max(a,t[s+e]);r[2*s]=127*o,r[2*s+1]=127*a}},e.parseAudio=function(e){return AUDIO.filename=e.name,renderAudio(),new Promise(n=>{const o=new t,r=new FileReader;r.readAsArrayBuffer(e),r.addEventListener("loadend",t=>{console.debug(`decoding ${e.type}...`);const a=t=>{console.append("OK"),Object.assign(AUDIO,{id:CONFIG.show,url:URL.createObjectURL(e),filename:e.name,duration:Math.round(1e3*t.duration)/1e3,sampleRate:t.sampleRate,tempo:0,beats:0,channels:[]});for(let e=0;e<t.numberOfChannels;e++){const{tempo:n,beats:o}=new MusicTempo(t.getChannelData(e));o.forEach((e,t,n)=>{n[t]=Math.round(1e3*e)}),AUDIO.channels[e]={tempo:n,delay:o[0],end:o[o.length-1]},AUDIO.tempo+=parseInt(n),AUDIO.beats+=o.length,console.info(`-- @${e+1}: ${o.length} beats, TEMPO: ${n} BPM`)}AUDIO.tempo/=t.numberOfChannels,AUDIO.beats/=t.numberOfChannels,renderAudio(),saveAudioConfig().then(n)};"chrome"in window?o.decodeAudioData(r.result).catch(handleError).then(a):o.decodeAudioData(r.result,a,handleError)})})},e.saveAudioConfig=function(e=CONFIG.show,t=AUDIO){return uploadFile(`show/${e}.json`,JSON.stringify(AUDIO))},e.loadAudioConfig=function(e=CONFIG.show,t=AUDIO){return get(`show/${e}.json`).then(e=>{Object.assign(t,e),renderAudio()}).catch(()=>{Object.assign(t,AUDIO_DEFAULT),renderAudio()})},e.saveLightShow=function(e=CONFIG.show,t=AUDIO){return new Promise(e=>(SHOWS[0]=createLoop(0,AUDIO.channels[0],AUDIO.tempo),SHOWS[1]=createLoop(1,AUDIO.channels[1],AUDIO.tempo),uploadFile(`show/${CONFIG.show}A.lsb`,SHOWS[0]).then(()=>uploadFile(`show/${CONFIG.show}B.lsb`,SHOWS[1])).then(()=>e(SHOWS))))},e.clearLightShow=function(e=CONFIG.show,t=AUDIO){return new Promise(e=>request("DELETE",`show/${CONFIG.show}A.lsb`).then(()=>request("DELETE",`show/${CONFIG.show}B.lsb`)).then(e))},e.createLoop=function(e,t,n){const o=t.delay,r=t.end,a=Math.ceil(1e3/(n/60)),s=Math.round(a*AUDIO.ratio),l=a-s,i=Math.round(1*s),c=Math.round(1*l);let u=hexToIntString(AUDIO.color1),d=hexToIntString(AUDIO.color2);return AUDIO.swap&&e%2&&(u=hexToIntString(AUDIO.color2),d=hexToIntString(AUDIO.color1)),[`C 0 ${o} 0 0 0 0`,`L ${o} ${r-o}`,`\tC 0 ${s} ${i} ${u}`,`\tC ${s} ${l} ${c} ${d}`,"\tE "+a,"E "+r].join("\n")},e.createSequenceFromBeats=function(e,t=0){let n=`C 0 ${e[0]} 0 0 0 0\n`;return n+=e.map((n,o)=>{if(o+1<e.length){const r=Math.round(n),a=Math.round(e[o+1]-n),s=Math.round(a*AUDIO.ratio),l=a-s,i=Math.round(1*s),c=Math.round(1*l);let u=hexToIntString(AUDIO.color1),d=hexToIntString(AUDIO.color2);return AUDIO.swap&&t%2?[`C ${r} ${s} ${i} ${d}`,`C ${r+s} ${l} ${c} ${u}`].join("\n"):[`C ${r} ${s} ${i} ${u}`,`C ${r+s} ${l} ${c} ${d}`].join("\n")}}).join("\n"),n+="E "+e[e.length-1],n},e.hexToIntString=function(e){return e=e.replace(/[^0-9a-f]+/gi,""),[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)].join(" ")}}).call(this,n(0))},function(e,t,n){(function(e){e.handleError=function(){console.error(...arguments)},e.handleFile=function(e){return new Promise((t,n)=>{console.debug("select file: "+e.name),e.name.endsWith(".lsf")?parseLSF(e).then(t):e.name.endsWith(".ipx")||(e.type.startsWith("audio")?stopShow().then(()=>{setAttr("#player","src",URL.createObjectURL(e)),AUDIO&&AUDIO.filename===e.name?startShow().then(t):parseAudio(e).then(saveLightShow).then(t).then(startShow)}):(console.error("unsupported file format"),n("unsupported file format")))})},e.handleChange=function(e){if("change"===e.type&&"select-file"===e.target.id)for(let t of e.target.files)handleFile(t);else if(e.target.matches("grid.color-slider input")){const t=e.target.dataset.key,n=e.target.dataset.group;switch(color[n][t]=parseFloat(e.target.value),n){case"rgb":updateHSL();break;case"hsl":updateRGB()}renderColor(),"change"===e.type&&post("/color",Object.assign({segment:CONFIG.segment},color.rgb))}else if(e.target.matches('input[data-group="audio"]')){const{key:t}=e.target.dataset,n=e.target.value;switch(e.target.type){case"color":AUDIO[t]=n;break;case"range":AUDIO[t]=parseFloat(n)}"change"===e.type&&console.info(`set ${t} = ${JSON.stringify(AUDIO[t])}`)}},e.handleClick=function(e){if(e.target.dataset.segment)CONFIG.segment=e.target.dataset.segment,color={rgb:CONFIG[CONFIG.segment]},updateHSL(),render();else if(e.target.dataset.show)CONFIG.show=parseInt(e.target.dataset.show)||0,render(),stopShow().then(()=>{post("/config",{show:CONFIG.show}).then(()=>{CONFIG.show?loadAudioConfig():startShow()})});else if(e.target.dataset.action){switch(e.target.dataset.action){case"show-file-select-dialog":click("#select-file");break;case"reset-show-data":resetShow();break;case"save-show-data":saveShow();break;case"toggle-prop":const t=e.target.dataset.key;AUDIO[t]=!AUDIO[t],console.info(`set ${t} = ${AUDIO[t]?"on":"off"}`)}}else if(e.target.dataset.command){const t=e.target.dataset.command;sendCommand(t).then(()=>{switch(t){case"start":setProp("#player","currentTime",0),call("#player","play");break;case"resume":call("#player","play");break;case"end":call("#player","pause"),setProp("#player","currentTime",0);break;case"pause":call("#player","pause")}})}},e.handleDragOver=function(e){e.preventDefault()},e.handleDragLeave=function(e){e.preventDefault()},e.handleDragDrop=function(e){e.preventDefault();for(let t of e.dataTransfer.files)handleFile(t)},e.handleInit=function(){render(),fetchData()},window.addEventListener("dragover",handleDragOver,!0),window.addEventListener("dragleave",handleDragLeave,!0),window.addEventListener("drop",handleDragDrop,!0),window.addEventListener("change",handleChange,!0),window.addEventListener("input",handleChange,!0),window.addEventListener("click",handleClick,!0),window.addEventListener("touchstart",new Function,!0),window.addEventListener("load",handleInit)}).call(this,n(0))},function(e,t,n){(function(e){const t=/(\t)?([0-9]+)ms: setrgb [AB]+ ([0-9]+)ms > ([0-9]+), ([0-9]+), ([0-9]+)/i,n=/([0-9]+)ms: loop ([0-9]+)ms/i,o=/(\t)?([0-9]+)ms: end/i;e.parseLSF=function(e){const r=new FileReader;function a(e,r){const a=[];let s,l;r.split(/\r|\n|\r\n/).forEach(e=>{if(e.match(t)){let[,n,o,r,i,c,u]=e.match(t);s={type:"rgb",start:o,duration:0,transition:r,r:i,g:c,b:u},n?l.frames.push(s):(a.push(s),l=s)}else if(e.match(o)){let[,t,n]=e.match(o);s={type:"end",start:n},t?l.frames.push(s):(a.push(s),l=s)}else if(e.match(n)){let[,t,o]=e.match(n);s={type:"loop",start:t,duration:o,frames:[]},l=s,a.push(s)}});const i=[];!function e(t,n){t.forEach((o,r)=>{switch(o.type){case"rgb":o.duration=t[r+1].start-o.start,i.push([n?"\tC":"C",o.start,o.duration,o.transition,o.r,o.g,o.b].join(" "));break;case"loop":i.push(["L",o.start,o.duration].join(" ")),e(o.frames,!0);break;case"end":i.push([n?"\tE":"E",o.start].join(" "))}})}(a),console.log(i.join("\n"));const c=`/show/${CONFIG.show}${e}.lsb`,u=new Blob([i.join("\n")]);return uploadFile(c,u)}r.readAsText(e),r.onload=()=>{const e=r.result.split(/@\w+/g);1==e.length?a("A",e[0]).then(()=>a("B",e[0])):3==e.length?a("A",e[1]).then(()=>a("B",e[2])):console.warn("Unknown data format",r.result)}}}).call(this,n(0))}]);